---
title: "recruit data prep"
author: "D Perret"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      prompt = FALSE,
                      error = TRUE,
                      message = FALSE,
                      cache = FALSE,
                      cache.lazy = FALSE,
                      eval = TRUE,
                      eval.after = "fig.cap")

library(tidyverse)
library(rFIA)
library(ggplot2)
library(ggExtra)
library(rgdal)
library(sp)
library(ggsci)
library(raster)
library(splines)
library(lme4)
library(patchwork)
library(performance)
library(ggeffects)
select <- dplyr::select

# setting my preferred ggplot2 theme
theme_set(theme_bw())
theme_update(text = element_text(size=16, color = "black"),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(),
             strip.background = element_blank(),
             panel.border=element_rect(size=1.5))

# colors to be used in all map figures
mapcolor <- "wheat3"
linecolor <- "gray40"
regioncolors <- c("Cascade Mixed Forest" = "#009E73",
                  "Northern Rocky Mountain Forest-Steppe" = "#56B4E9",
                  "Middle Rocky Mountain Steppe" = "#E69F00",
                  "Southern Rocky Mountain Steppe" = "#CC79A7",
                  "zIntermountain Semi-Desert" = "gray20",
                  "AZ-NM Mountains" = "#D55E00")

# sourcing estimation base code
source("code/growMort_rewrite_METRIC.R")

```

PAIRED DOC WITH 'ABLAPIEN_MORTALITY' AND 'ABLAPIEN_REGEN'

Here we're prepping data and figuring out a modeling approach for subalpine fir and engelmann spruce recruitment models


We'll start by doing a change estimation at the plot level so we can either use RECR estimates and/or get a better sense of what to focus on (e.g., sapling recruitment? adult recruitment?)

ADULT (DBH>12.7) RECRUITMENT --> ONLY SUBPLOT DATA
```{r}
thresh <- 12.7

dtpa.plot2 <- growMort_dlp.metric(db = all.fia,
                                  stateVar = "TPA",
                                  byPlot = TRUE,
                                  grpBy = SPCD,
                                  totals = TRUE,
                                  returnSpatial = FALSE, 
                                  nCores = 4,
                                  sizeThresh=thresh,
                                  evals = evals,
                                  method="TI",
                                  treeList = F)


dtpa.plot.sp2 <- dtpa.plot2 %>% 
  filter(SPCD %in% c(19,93))


dtpa.plot.sp %>% 
  ggplot(.,
         aes(x = RECR_TPA/74,
             fill = factor(SPCD)))+
  geom_density(alpha=0.4)


counts <- all.fia$TREE %>% 
  filter(PLT_CN %in% dtpa.plot.sp$PLT_CN,
         SPCD %in% c(19,93),
         is.na(PREV_TRE_CN),
         DIA > 12.7,
         STATUSCD==1) %>%
  count(TPA_UNADJ)
  
  group_by(PLT_CN,SPCD) %>% 
  summarise(count=n())

```

SAPLING PRESENCE DATA

```{r}

sap <- data.frame(PLT_CN = rep(unique(ind.mort.dat$PLT_CN),each=2),
                  SPCD=c(19,93)) %>% 
  left_join(all.fia$TREE %>% 
              filter(SPCD %in% c(19,93),
                     DIA < 12.7,
                     is.na(PREV_TRE_CN),  # ONLY NEW SAPLINGS
                     PLT_CN %in% co.pres.plots,
                     INVYR > 2009) %>% 
              group_by(PLT_CN, SPCD) %>% 
              summarise(sap_count = n()),
            by = c("PLT_CN","SPCD")) %>% 
  mutate(sap_count = ifelse(is.na(sap_count),0,sap_count),
         sap_pres = ifelse(sap_count>0,1,sap_count))

sap.dat <- sap %>% 
  left_join(.,
            all.fia$PLOT %>% 
              select(PLT_CN,
                     contains("MAT"),
                     contains("MAP"),
                     contains("CMD"),
                     ECOSUBCD, REMPER,# ECO_GRP_NEW_NAM,
                     INVYR, ELEV, most.recent) %>% 
              mutate(MAT_anom = MAT_remper-MAT_19802010,
                     MAP_anom = MAP_remper-MAP_19802010,
                     CMD_anom = CMD_remper-CMD_19802010,
                     MAP_relanom = MAP_anom/MAP_19802010),
            by="PLT_CN") %>% 
  left_join(micr.cond,
            by=c("PLT_CN")) %>% 
  left_join(mort.area.er %>% 
              mutate(area.fire.prop = area.fire/area.total,
                     area.id.prop = area.id/area.total),
            by="ECOSUBCD") %>% 
  left_join(plot.attributes.prev, by = "PLT_CN") %>% 
  mutate(yr.since.fire = ifelse(fire == "burned",
                                INVYR-fire.year,
                                NA),
         yr.since.dist = case_when(disturbance == "fire" ~ INVYR - fire.year,
                                   disturbance == "fire/bda" ~ INVYR - fire.year,
                                   disturbance == "bda" ~ INVYR - bda.year,
                                   bda.year == 9999 ~ INVYR - INVYR),
         yr.since.fire = ifelse(is.na(yr.since.fire),
                                100, yr.since.fire),
         yr.since.dist = ifelse(is.na(yr.since.dist),
                                100, yr.since.dist),
         SPCD=factor(SPCD)) %>% 
  left_join(dist.sev,
            by=c("PLT_CN","SPCD")) %>% 
  mutate(fire.sev = ifelse(is.na(fire.sev),0,fire.sev),
         bda.sev = ifelse(is.na(bda.sev),0,bda.sev),
         dist.sev = ifelse(is.na(dist.sev),0,dist.sev),
         mort.prop = ifelse(is.na(mort.prop),0,mort.prop)) %>% 
  filter(!is.na(ASPECT),
         !is.na(MAT_19802010))


```









































