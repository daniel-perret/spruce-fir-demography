---
title: "recruit data prep"
author: "D Perret"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      prompt = FALSE,
                      error = TRUE,
                      message = FALSE,
                      cache = FALSE,
                      cache.lazy = FALSE,
                      eval = TRUE,
                      eval.after = "fig.cap")

library(tidyverse)
library(rFIA)
library(ggplot2)
library(ggExtra)
library(rgdal)
library(sp)
library(ggsci)
library(raster)
library(splines)
library(lme4)
library(patchwork)
library(performance)
library(ggeffects)
select <- dplyr::select

# setting my preferred ggplot2 theme
theme_set(theme_bw())
theme_update(text = element_text(size=16, color = "black"),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(),
             strip.background = element_blank(),
             panel.border=element_rect(size=1.5))

# colors to be used in all map figures
mapcolor <- "wheat3"
linecolor <- "gray40"
regioncolors <- c("Cascade Mixed Forest" = "#009E73",
                  "Northern Rocky Mountain Forest-Steppe" = "#56B4E9",
                  "Middle Rocky Mountain Steppe" = "#E69F00",
                  "Southern Rocky Mountain Steppe" = "#CC79A7",
                  "zIntermountain Semi-Desert" = "gray20",
                  "AZ-NM Mountains" = "#D55E00")

# sourcing estimation base code
source("code/growMort_rewrite_METRIC.R")

```

PAIRED DOC WITH 'ABLAPIEN_MORTALITY' AND 'ABLAPIEN_REGEN'

Here we're prepping data and figuring out a modeling approach for subalpine fir and engelmann spruce recruitment models


We'll start by doing a change estimation at the plot level so we can either use RECR estimates and/or get a better sense of what to focus on (e.g., sapling recruitment? adult recruitment?)

ADULT (DBH>12.7) RECRUITMENT --> ONLY SUBPLOT DATA
```{r}
thresh <- 12.7

dtpa.plot <- growMort_dlp.metric(db = all.fia,
                                  stateVar = "TPA",
                                  byPlot = TRUE,
                                  grpBy = SPCD,
                                  totals = TRUE,
                                  returnSpatial = FALSE, 
                                  nCores = 4,
                                  sizeThresh=thresh,
                                  evals = evals,
                                  method="TI",
                                  treeList = F)


dtpa.plot.sp <- dtpa.plot %>% 
  filter(SPCD %in% c(19,93))


dtpa.plot.sp %>% 
  ggplot(.,
         aes(x = RECR_TPA/74,
             fill = factor(SPCD)))+
  geom_density(alpha=0.4)


counts <- all.fia$TREE %>% 
  filter(PLT_CN %in% dtpa.plot.sp$PLT_CN,
         SPCD %in% c(19,93),
         is.na(PREV_TRE_CN),
         DIA > 12.7,
         STATUSCD==1) %>%
  count(TPA_UNADJ)
  
  group_by(PLT_CN,SPCD) %>% 
  summarise(count=n())

```











































