---
title: "Individual-level ABLA+ mortality models"
author: "D Perret"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      prompt = FALSE,
                      error = TRUE,
                      message = FALSE,
                      cache = FALSE,
                      cache.lazy = FALSE,
                      eval = TRUE,
                      eval.after = "fig.cap")

library(tidyverse)
library(rFIA)
library(ggplot2)
library(ggExtra)
library(rgdal)
library(sp)
library(ggsci)
library(raster)
library(splines)
library(lme4)
library(patchwork)
library(performance)
library(ggeffects)
select <- dplyr::select

# setting my preferred ggplot2 theme
theme_set(theme_bw())
theme_update(text = element_text(size=16, color = "black"),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(),
             strip.background = element_blank(),
             panel.border=element_rect(size=1.5))

# colors to be used in all map figures
mapcolor <- "wheat3"
linecolor <- "gray40"
regioncolors <- c("Cascade Mixed Forest" = "#009E73",
                  "Northern Rocky Mountain Forest-Steppe" = "#56B4E9",
                  "Middle Rocky Mountain Steppe" = "#E69F00",
                  "Southern Rocky Mountain Steppe" = "#CC79A7",
                  "zIntermountain Semi-Desert" = "gray20",
                  "AZ-NM Mountains" = "#D55E00")

# sourcing estimation base code
source("/Users/DanielPerret/Box/01. daniel.perret Workspace/PROJECTS/status_trends/growMort_rewrite_METRIC.R")

```

# Data preparation

## FIA data

```{r fia.data, echo=T}

# reading downloaded FIA data from a local directory, using rFIA functionality

all.fia <- readFIA(dir = "/Users/DanielPerret/Box/01. daniel.perret Workspace/fia_data_082123/",
                   common=T, states=c("WA","OR","ID","MT","WY","UT","CO",
                                      "CA","NV","NM","AZ"))

#creating some fields in various tables

all.fia$PLOT <- all.fia$PLOT %>% 
  mutate(pltID = paste(UNITCD,STATECD,COUNTYCD,PLOT,sep="_"),
         PLT_CN = CN,
         ECOSUBCD = trimws(ECOSUBCD),
         state_key = case_when(STATECD == 8 ~ "CO",
                               STATECD == 30 ~ "MT",
                               STATECD == 16 ~ "ID",
                               STATECD == 41 ~ "OR",
                               STATECD == 53 ~ "WA",
                               STATECD == 49 ~ "UT",
                               STATECD == 56 ~ "WY",
                               STATECD == 6 ~ "CA",
                               STATECD == 32 ~ "NV",
                               STATECD == 35 ~ "NM",
                               STATECD == 4 ~ "AZ")) %>% 
  group_by(pltID) %>% 
  mutate(most.recent = ifelse(MEASYEAR==max(MEASYEAR),
                              "yes","no")) %>% 
  ungroup()

all.fia$COND <- all.fia$COND %>% 
  left_join(all.fia$PLOT %>% 
              select(PLT_CN,most.recent),
            by="PLT_CN") %>% 
  mutate(state_key = case_when(STATECD == 8 ~ "CO",
                               STATECD == 30 ~ "MT",
                               STATECD == 16 ~ "ID",
                               STATECD == 41 ~ "OR",
                               STATECD == 53 ~ "WA",
                               STATECD == 49 ~ "UT",
                               STATECD == 56 ~ "WY"))


# Because annual inventories began later in Wyoming, we need to link back to earlier period inventories in order to make our eventual change estimates. This code does that by using plot number links and tree azimuth and distance. Note that the files necessary to do this (i.e., "wy_p2alink.csv" and "wy_p2alink_tree.csv") are NOT included in these supplementary materials because they could be used to infer exact plot coordinates, which are protected.

## plots
wy.p2a.plotlink <- read.csv("wy_p2alink.csv",header=T,stringsAsFactors=F) %>%
  select(CN, PREV_PLT_CN.update = PREV_PLT_CN)

### updating plots
all.fia$PLOT <- all.fia$PLOT %>% 
  left_join(., wy.p2a.plotlink,
            by="CN") %>% 
  mutate(PREV_PLT_CN = ifelse(!is.na(PREV_PLT_CN.update),
                              PREV_PLT_CN.update,
                              PREV_PLT_CN)) %>% 
  select(-PREV_PLT_CN.update) %>% 
  left_join(all.fia$PLOT %>% 
              select(PLT_CN,MEASYEAR.prev = MEASYEAR),
            by = c("PREV_PLT_CN"="PLT_CN")) %>% 
  mutate(REMPER = ifelse(is.na(REMPER),
                         MEASYEAR-MEASYEAR.prev,
                         REMPER))
## trees
wy.p2a.treelink <- read.csv("wy_p2alink_tree.csv",header=T,stringsAsFactors=F) %>% 
  rename(PREV_TRE_CN.update = PREV_TRE_CN)

all.fia$TREE <- all.fia$TREE %>% 
  left_join(., wy.p2a.treelink,
            by="CN") %>% 
  mutate(PREV_TRE_CN = ifelse(!is.na(PREV_TRE_CN.update),
                              PREV_TRE_CN.update,
                              PREV_TRE_CN)) %>% 
  select(-PREV_TRE_CN.update,
         -PREVDIA,
         -PREV_STATUS_CD) %>% 
  left_join(., all.fia$TREE %>% 
              select(CN, PREVDIA=DIA, PREV_STATUS_CD = STATUSCD),
            by = c("PREV_TRE_CN" = "CN"))

# Other data curation steps

## creating some fields and updating all SPCDs to most-recently ID'd SPCD -- this is necessary because it's quite common for trees to change species ID, especially in smaller age classes.

all.fia$TREE <- all.fia$TREE %>% 
  left_join(all.fia$PLOT %>% 
              select(PLT_CN,most.recent),
            by="PLT_CN") %>% 
  mutate(TRE_CN = CN,
         DIA = DIA*2.54,
         PREVDIA = PREVDIA*2.54,
         state_key = case_when(STATECD == 8 ~ "CO",
                               STATECD == 30 ~ "MT",
                               STATECD == 16 ~ "ID",
                               STATECD == 41 ~ "OR",
                               STATECD == 53 ~ "WA",
                               STATECD == 49 ~ "UT",
                               STATECD == 56 ~ "WY"),
         agent_key = case_when(STATUSCD==2 & AGENTCD %in% c(00,70) ~ "unknown1",
                               STATUSCD==2 & AGENTCD == 10 ~ "insect",
                               STATUSCD==2 & AGENTCD == 20 ~ "disease",
                               STATUSCD==2 & AGENTCD == 30 ~ "fire",
                               STATUSCD==2 & AGENTCD == 40 ~ "animal",
                               STATUSCD==2 & AGENTCD == 50 ~ "weather",
                               STATUSCD==2 & AGENTCD == 60 ~ "competition",
                               STATUSCD==2 & AGENTCD == 80 ~ "land use",
                               STATUSCD==2 & is.na(AGENTCD) & 
                                 (PREV_STATUS_CD==1 | 
                                    is.na(PREV_STATUS_CD)) ~ "unknown2"),
         insect.damage = case_when(DAMAGE_AGENT_CD1 >= 10000 &
                                     DAMAGE_AGENT_CD1 < 19000 ~ 1,
                                   DAMAGE_AGENT_CD2 >= 10000 &
                                     DAMAGE_AGENT_CD2 < 19000 ~ 1,
                                   DAMAGE_AGENT_CD3 >= 10000 &
                                     DAMAGE_AGENT_CD3 < 19000 ~ 1,
                                   TRUE ~ 0),
         disease.damage = case_when(DAMAGE_AGENT_CD1 >= 20000 &
                                      DAMAGE_AGENT_CD1 < 30000 ~ 1,
                                    DAMAGE_AGENT_CD2 >= 20000 &
                                      DAMAGE_AGENT_CD2 < 30000 ~ 1,
                                    DAMAGE_AGENT_CD3 >= 20000 &
                                      DAMAGE_AGENT_CD3 < 30000 ~ 1,
                                    TRUE ~ 0),
         other.damage = case_when(DAMAGE_AGENT_CD1 > 30000 ~ 1,
                                  DAMAGE_AGENT_CD2 > 30000 ~ 1,
                                  DAMAGE_AGENT_CD3 > 30000 ~ 1,
                                  TRUE ~ 0)) %>% 
  left_join(.,
            all.fia$TREE %>% 
              select(PREV_TRE_CN, SPCD) %>% 
              rename(LATER_SPCD=SPCD),
            by=c("TRE_CN"="PREV_TRE_CN")) %>% 
  mutate(SPCD = case_when(SPCD!=LATER_SPCD & !is.na(LATER_SPCD) ~ LATER_SPCD,
                          is.na(LATER_SPCD) ~ SPCD,
                          TRUE ~ SPCD),
         SPCD = ifelse(SPCD==18, 19, SPCD))

## some summary dataframes and fields for convenience
abla.trees <- all.fia$TREE %>% 
  filter(SPCD == 19)

all.fia$PLOT <- all.fia$PLOT %>% 
  mutate(abla.pres = ifelse(PLT_CN %in% unique(abla.trees$PLT_CN),
                            1,0))

abla.plots <- all.fia$PLOT %>% 
  filter(abla.pres==1)

abla.cond <- all.fia$COND %>% 
  filter(PLT_CN %in% abla.plots$PLT_CN)

plot.summary <- all.fia$TREE %>% 
  filter(most.recent == "yes",
         PLT_CN %in% abla.plots$PLT_CN,
         STATUSCD %in% 1:2
  ) %>%
  mutate(focal = ifelse(SPCD == "19", "abla", "nonabla"),
         status = ifelse(STATUSCD == 1, "live","dead"),
         DIAcm = DIA*2.54,
         BAcm = pi*(DIAcm/2)^2,
         BAcm.pa = BAcm*TPA_UNADJ) %>% 
  group_by(PLT_CN, focal, status) %>% 
  summarise(BAcm = sum(BAcm,na.rm=T),
            meanBAcm = mean(BAcm,na.rm=T),
            BAcm.pa = sum(BAcm.pa,na.rm=T),
            stems = n(),
            stems.pa = sum(TPA_UNADJ,na.rm=T)) %>%
  ungroup() %>% 
  pivot_wider(.,
              names_from = c(focal,status),
              names_glue = "{focal}.{status}.{.value}",
              values_from = c(BAcm, meanBAcm, BAcm.pa, stems, stems.pa),
              values_fill = 0) %>% 
  mutate(abla.tot.stems.pa = abla.live.stems.pa+abla.dead.stems.pa,
         abla.tot.BAcm.pa = abla.live.BAcm.pa+abla.dead.BAcm.pa,
         abla.live.stems.prop = abla.live.stems.pa/abla.tot.stems.pa,
         abla.live.BAcm.prop = abla.live.BAcm.pa/abla.tot.BAcm.pa,
         
         nonabla.tot.stems.pa = nonabla.live.stems.pa+nonabla.dead.stems.pa,
         nonabla.tot.BAcm.pa = nonabla.live.BAcm.pa+nonabla.dead.BAcm.pa,
         nonabla.live.stems.prop = nonabla.live.stems.pa/nonabla.tot.stems.pa,
         nonabla.live.BAcm.prop = nonabla.live.BAcm.pa/nonabla.tot.BAcm.pa,
         
         tot.stems.pa = abla.tot.stems.pa + nonabla.tot.stems.pa,
         tot.BAcm.pa = abla.tot.BAcm.pa + nonabla.tot.BAcm.pa) %>% 
  left_join(., abla.plots,
            by = "PLT_CN")


```

## Climate data

```{r climate.data, echo=T}
# 
# # reading in 1981 - 2010 climate normals, downloaded from ClimateNA
# clim.norms <- read.csv("D:/coords_format_Normal_1981_2010Y.csv", header=T) %>% 
#   select(PLT_CN=ID1,
#          MAT,
#          MAP,
#          DD5,
#          CMD,
#          CMI,
#          FFP) %>% 
#   mutate(MAT = ifelse(MAT==-9999, NA_real_, MAT))
# 
# # reading in 1901-2021 climate timeseries, downloaded from ClimateNA
# clim.ann <- read.csv("D:/coords_format_1901-2021Y.csv", header=T)
# 
# # summarizing climate variables to match the remeasurement period of all FIA plots
# clim.remper <- clim.ann %>%
#   select(PLT_CN=ID1,
#          Year, 7:31) %>% 
#   mutate(across(where(is.numeric), .fns = ~ifelse(.x==-9999,NA_real_,.x))) %>% 
#   left_join(all.fia$PLOT %>% 
#               mutate(REMPER_END = MEASYEAR,
#                      REMPER_START = MEASYEAR-round(REMPER,digits=0)) %>% 
#               select(PLT_CN, REMPER_END, REMPER_START)) %>% 
#   mutate(REMPER_START = ifelse(is.na(REMPER_START), REMPER_END, REMPER_START),
#          across(3:27, .fns = ~ifelse(Year %in% c(REMPER_START:REMPER_END), .x, NA_real_))) %>%
#   group_by(PLT_CN) %>% 
#   summarise(across(MAT:DD1040, ~mean(.x,na.rm=T), .names="{.col}_remper"))
# 
# # summarizing climate variables for a "baseline" period 1900-1950
# clim.base <- clim.ann %>%
#   select(PLT_CN=ID1,
#          Year, 7:31) %>% 
#   filter(Year %in% 1900:1950) %>% 
#   mutate(across(where(is.numeric), .fns = ~ifelse(.x==-9999,NA_real_,.x))) %>% 
#   group_by(PLT_CN) %>% 
#   summarise(across(MAT:DD1040, ~mean(.x,na.rm=T), .names = "{.col}_base"))
# 
# # summarizing climate variables for a "recent" period 2010-2021
# clim.recent <- clim.ann %>%
#   select(PLT_CN=ID1,
#          Year, 7:31) %>% 
#   filter(Year %in% 2010:2021) %>% 
#   mutate(across(where(is.numeric), .fns = ~ifelse(.x==-9999,NA_real_,.x))) %>% 
#   group_by(PLT_CN) %>% 
#   summarise(across(MAT:DD1040, ~mean(.x,na.rm=T), .names = "{.col}_recent"))
# 
# 
# write.csv(clim.norms, file = "clim_norms.csv", row.names = F)
# write.csv(clim.base, file = "clim_base.csv", row.names = F)
# write.csv(clim.remper, file = "clim_remper.csv", row.names = F)
# write.csv(clim.recent, file = "clim_recent.csv", row.names = F)

## Only re-run climate processing code if something needs to be changed! It takes forever to run!

clim.norms <- read.csv("clim_norms.csv",header=T,stringsAsFactors=F)
clim.base <- read.csv("clim_base.csv", header=T, stringsAsFactors=F)
clim.remper <- read.csv("clim_remper.csv",header=T,stringsAsFactors=F)
clim.recent <- read.csv("clim_recent.csv",header=T,stringsAsFactors=F)

# joining climate variables to FIA plots
all.fia$PLOT <- all.fia$PLOT %>% 
  left_join(clim.norms,
            by="PLT_CN") %>%
  left_join(clim.remper,
            by="PLT_CN") %>%
  left_join(clim.base,
            by="PLT_CN") %>%
  left_join(clim.recent,
            by="PLT_CN") %>% 
  mutate(REMPER_END = MEASYEAR,
         REMPER_START = MEASYEAR-round(REMPER,digits=0),
         REMPER_PER = length(REMPER_START:REMPER_END))


```

## Spatial data

```{r}

# WGS84
old.proj <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

# Albers Equal Area; centered in western US
base.proj <- "+proj=aea +lat_0=23 +lon_0=-96 +lat_1=29.5 +lat_2=45.5 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs"

# US state boundaries
states <- readOGR(dsn="/Users/DanielPerret/Box/01. daniel.perret Workspace/base_spatialdata/state_boundaries",
                  layer = "state_boundaries", verbose=F) %>% 
  spTransform(.,
              CRSobj = CRS(base.proj))

# North American continent
cont <- readOGR(dsn="/Users/DanielPerret/Box/01. daniel.perret Workspace/base_spatialdata/continents",
                layer = "na",
                verbose=F,
                p4s = old.proj) %>% 
  spTransform(.,
              CRSobj = CRS(base.proj))

# Subalpine fir range
range <- readOGR(dsn="/Users/DanielPerret/Box/01. daniel.perret Workspace/base_spatialdata/named_ranges",
                 layer = "abielasi",
                 verbose = F,
                 p4s = old.proj) %>% 
  spTransform(.,
              CRSobj = CRS(base.proj))

# making a SpatialPointsDataFrame for subalpine fir plot locations (fuzzed)
abla.sp <- abla.plots %>% 
  SpatialPointsDataFrame(coords = .[,c("LON","LAT")],
                         data = .,
                         proj4string = CRS(old.proj)) %>% 
  spTransform(.,
              CRSobj = CRS(base.proj))

# Level 4 ecoregions (i.e., ecoregion subsections)
er4 <- readOGR(dsn="/Users/DanielPerret/Box/01. daniel.perret Workspace/base_spatialdata/cleland_usfs_ecoregions",
               layer = "S_USA.EcomapSubsections",
               verbose=F) %>% 
  spTransform(.,
              CRSobj = CRS(base.proj))

# Level 3 ecoregions (i.e., ecoregion sections)
er3 <- readOGR(dsn="/Users/DanielPerret/Box/01. daniel.perret Workspace/base_spatialdata/cleland_usfs_ecoregions",
               layer = "S_USA.EcomapSections",
               verbose=F) %>% 
  spTransform(.,
              CRSobj = CRS(base.proj))

# Level 2 ecoregions (i.e., ecological provinces)
er2 <- readOGR(dsn="/Users/DanielPerret/Box/01. daniel.perret Workspace/base_spatialdata/cleland_usfs_ecoregions",
               layer = "S_USA.EcoMapProvinces",
               verbose=F) %>% 
  spTransform(.,
              CRSobj = CRS(base.proj))

# extracting ecoregions that contain subalpine fir

er4.abla <- er4[abla.sp,]
er3.abla <- er3[abla.sp,]
er2.abla <- er2[abla.sp,]

```

## Ecoprovince groupings

```{r}

# Joining plot locations with ecological province designations, then lumping similar designations to form broader groups. See Cleland et al. 2006 for more information about designations.

PLOT.sp <- all.fia$PLOT %>% 
  filter(!is.na(LON)) %>% 
  SpatialPointsDataFrame(coords= .[,c("LON","LAT")],
                         data = .,
                         proj4string = CRS(old.proj)) %>% 
  spTransform(.,CRSobj=CRS(base.proj)) %>% 
  as(.,"sf") %>% 
  sf::st_join(., er2 %>% 
                as(.,"sf") %>% 
                select(ECOPROVCD=MAP_UNIT_S,
                       ECOPROVNAM=MAP_UNIT_N),
              left=T) %>% 
  mutate(ECO_GRP_NEW = case_when(ECOPROVCD %in% c("242","M242") ~ "M242",
                                 ECOPROVCD %in% c("341", "M341","342") ~ "M341",
                                 ECOPROVCD %in% c("331", "M331") ~ "M331",
                                 ECOPROVCD %in% c("313", "M313", "321") ~ "M313",
                                 is.na(ECOPROVCD) ~ "M333",
                                 TRUE~ECOPROVCD),
         ECO_GRP_NEW_NAM = case_when(ECO_GRP_NEW == "M242" ~ "Cascade Mixed Forest",
                                     ECO_GRP_NEW == "M313" ~ "AZ-NM Mountains",
                                     ECO_GRP_NEW == "M331" ~ "Southern Rocky Mountain Steppe",
                                     ECO_GRP_NEW == "M332" ~ "Middle Rocky Mountain Steppe",
                                     ECO_GRP_NEW == "M333" ~ "Northern Rocky Mountain Forest-Steppe",
                                     ECO_GRP_NEW == "M341" ~ "zIntermountain Semi-Desert",
                                     TRUE ~ "Cascade Mixed Forest"))

# joining designations back to FIA plot tables

all.fia$PLOT <- all.fia$PLOT %>% 
  left_join(., PLOT.sp %>% 
              sf::st_drop_geometry() %>% 
              select(PLT_CN, ECOPROVCD,ECOPROVNAM, ECO_GRP_NEW, ECO_GRP_NEW_NAM),
            by="PLT_CN")
```

## Population estimation

```{r}

# rewritten estimation code needs us to specify the EvalIDs that we're interested in
evals <- c(21903,41903,61903,81903,161903,301903,321903,351903,411903,491903,531903,561903)

# minimum size threshold for estimate
thresh <- 12.7

## Density change estimates for all species
dtpa.er.sp <- growMort_dlp.metric(db = all.fia,
                           stateVar = "TPA",
                           polys = er4.abla %>%
                             sf::st_as_sf() %>%
                             select(MAP_UNIT_S),
                           # areaDomain = abla.pres == 1, # this makes the AREA_TOTAL reflect only area that contains subalpine fir
                           grpBy = SPCD,
                           totals = TRUE,
                           returnSpatial = T, 
                           nCores = 4,
                           #variance = T,
                           sizeThresh=thresh,
                           evals = evals,
                           method="TI") %>% 
  group_by(MAP_UNIT_S) %>% 
  filter(YEAR==max(YEAR)) # 2019 inventory for all states but WY

## Basal area change estimates for all species
dbaa.er.sp <- all.fia %>% 
  growMort_dlp.metric(db = .,
               stateVar = "BAA",
               polys = er4.abla %>%
                 sf::st_as_sf() %>% 
                 select(MAP_UNIT_S),
               # areaDomain = abla.pres == 1,
               grpBy = SPCD,
               totals = TRUE,
               returnSpatial = F, 
               nCores = 4,
               #variance = T,
               sizeThresh=thresh,
               evals = evals,
               method="TI") %>% 
  group_by(MAP_UNIT_S) %>% 
  filter(YEAR==max(YEAR))

#combining TPA and BAA change estimates
dall.er.sp <- left_join(dtpa.er.sp, dbaa.er.sp,
                        suffix = c(".tpa",".baa"),
                        by=c("MAP_UNIT_S","polyID","SPCD","YEAR","N",
                             "nPlots_TREE","nPlots_AREA","AREA_TOTAL_ha"))



# total agent-specific mortality for all species
dtpa.er.sp.agent <- all.fia %>% 
  growMort_dlp.metric(db = .,
               stateVar = "TPA",
               polys = er4.abla %>%
                 sf::st_as_sf() %>% 
                 select(MAP_UNIT_S),
               totals = TRUE,
               grpBy = c(SPCD, agent_key),
               returnSpatial = T, 
               nCores = 4,
               #variance = T,
               sizeThresh = thresh,
               evals = evals,
               method="TI") %>% 
  group_by(MAP_UNIT_S) %>% 
  filter(YEAR==max(YEAR))

# summarising mortality and estimating recruitment
mort.decomp.sp <- 
  dtpa.er.sp %>% 
  left_join(dtpa.er.sp.agent %>%
              sf::st_drop_geometry() %>% 
              group_by(MAP_UNIT_S,SPCD) %>% 
              summarise(FIRE_MORT = sum((CURR_TOTAL-PREV_TOTAL)*ifelse(agent_key=="fire",1,0),na.rm=T)*-1,
                        DISEASE_MORT = sum((CURR_TOTAL-PREV_TOTAL)*ifelse(agent_key=="disease",1,0),na.rm=T)*-1,
                        INSECT_MORT = sum((CURR_TOTAL-PREV_TOTAL)*ifelse(agent_key=="insect",1,0),na.rm=T)*-1,
                        ID_MORT = sum((CURR_TOTAL-PREV_TOTAL)*ifelse(agent_key%in%c("insect","disease"),1,0),na.rm=T)*-1),
            by=c("MAP_UNIT_S","SPCD")) %>%
  mutate(MORT_TOTAL = ifelse(is.na(MORT_TOTAL),0,MORT_TOTAL),
         FIRE_MORT = ifelse(is.na(FIRE_MORT),0,FIRE_MORT),
         INSECT_MORT = ifelse(is.na(INSECT_MORT),0,INSECT_MORT),
         DISEASE_MORT = ifelse(is.na(DISEASE_MORT),0,DISEASE_MORT),
         ID_MORT = ifelse(is.na(ID_MORT),0,ID_MORT),
         CHNG_PERC_tot = (CURR_TOTAL-PREV_TOTAL)/PREV_TOTAL,
         RECR_est = (CURR_TOTAL-PREV_TOTAL) + MORT_TOTAL,
         fire.pace = ifelse(FIRE_MORT>RECR_est, "no", "yes"),
         id.pace = ifelse(ID_MORT > RECR_est, "no", "yes"),
         other.pace = ifelse(MORT_TOTAL-(FIRE_MORT+ID_MORT) > RECR_est, "no", "yes"),
         all.pace = ifelse(MORT_TOTAL > RECR_est, "no","yes"),
         minus.fire = ifelse(MORT_TOTAL-FIRE_MORT > RECR_est, "no", "yes"),
         minus.id = ifelse(MORT_TOTAL - ID_MORT > RECR_est, "no", "yes")) %>% 
  left_join(all.fia$PLOT %>% 
              filter(most.recent=="yes",
                     !is.na(REMPER)) %>% 
              select(PLT_CN,ECOSUBCD,MEASYEAR,REMPER) %>% 
              mutate(REMPER=round(REMPER,0)) %>% 
              group_by(ECOSUBCD) %>% 
              summarise(minT1yr = min(MEASYEAR-REMPER),
                        maxT1yr = max(MEASYEAR-REMPER),
                        minT2yr = min(MEASYEAR),
                        maxT2yr = max(MEASYEAR)),
            by=c("MAP_UNIT_S"="ECOSUBCD"))

# filtering for abla
mort.decomp.abla <- mort.decomp.sp %>% 
  filter(SPCD==19,
         CURR_TOTAL>0 | PREV_TOTAL>0)

# summarising for abla-specific rates----

# binning estimates by subalpine fir and non-subalpine fir
dall.er.abla <- dall.er.sp %>% 
  filter(SPCD%in%c(19,93)) %>% # this line will drop all species except ABLA and PIEN... is this the way to go about this?
  mutate(sp.indicator = ifelse(SPCD==19, 1, 0)) %>% 
  group_by(MAP_UNIT_S) %>%
  summarise(CURR_BAA.abla = sum(CURR_TOTAL.baa*sp.indicator),
            PREV_BAA.abla = sum(PREV_TOTAL.baa*sp.indicator),
            CURR_BAA.all = sum(CURR_TOTAL.baa),
            PREV_BAA.all = sum(PREV_TOTAL.baa),
            
            CURR_TPA.abla = sum(CURR_TOTAL.tpa*sp.indicator),
            CURR_TPA.abla.var = sum(CURR_TOTAL_VAR.tpa*sp.indicator),
            
            PREV_TPA.abla = sum(PREV_TOTAL.tpa*sp.indicator),
            PREV_TPA.abla.var = sum(PREV_TOTAL_VAR.tpa*sp.indicator),
            
            CHNG_TOTAL.tpa.abla = sum(CHNG_TOTAL.tpa*sp.indicator,na.rm=T),
            CHNG_TOTAL.tpa.abla.var = sum(CHNG_TOTAL_VAR.tpa*sp.indicator,na.rm=T),
            CHNG_PERC.tpa.abla = sum(CHNG_PERC.tpa*sp.indicator,na.rm=T),
            CHNG_PERC.tpa.abla.var = sum(CHNG_PERC_VAR.tpa*sp.indicator,na.rm=T),
            
            CHNG_TOTAL.baa.abla = sum(CHNG_TOTAL.baa*sp.indicator,na.rm=T),
            CHNG_TOTAL.baa.abla.var = sum(CHNG_TOTAL_VAR.baa*sp.indicator,na.rm=T),
            CHNG_PERC.baa.abla = sum(CHNG_PERC.baa*sp.indicator,na.rm=T),
            CHNG_PERC.baa.abla.var = sum(CHNG_PERC_VAR.baa*sp.indicator,na.rm=T),
            
            CURR_TPA.all = sum(CURR_TOTAL.tpa),
            PREV_TPA.all = sum(PREV_TOTAL.tpa),
            AREA = mean(AREA_TOTAL_ha))%>% 
  mutate(CURR_BAA.prop = CURR_BAA.abla/CURR_BAA.all,
         CURR_TPA.prop = CURR_TPA.abla/CURR_TPA.all,
         PREV_BAA.prop = PREV_BAA.abla/PREV_BAA.all,
         PREV_TPA.prop = PREV_TPA.abla/PREV_TPA.all,
         BAA_CHNG_PERC = (CURR_BAA.abla-PREV_BAA.abla)/PREV_BAA.abla,
         TPA_CHNG_PERC = (CURR_TPA.abla-PREV_TPA.abla)/PREV_TPA.abla,
         
         CHNG_PERC.tpa.abla.sd = sqrt(CHNG_PERC.tpa.abla.var),
         
         BAA_CHNG_PERC.nonabla = ((CURR_BAA.all-CURR_BAA.abla)-(PREV_BAA.all-PREV_BAA.abla))/(PREV_BAA.all-PREV_BAA.abla),
         TPA_CHNG_PERC.nonabla = ((CURR_TPA.all-CURR_TPA.abla)-(PREV_TPA.all-PREV_TPA.abla))/(PREV_TPA.all-PREV_TPA.abla),
         BAA_CHNG_PERC.all = (CURR_BAA.all-PREV_BAA.all)/PREV_BAA.all,
         TPA_CHNG_PERC.all = (CURR_TPA.all-PREV_TPA.all)/PREV_TPA.all,
         
         # creating "change categories" -- ie., does subalpine fir trajectory match that for other species?
         quadrant.baa = case_when(BAA_CHNG_PERC < 0 & BAA_CHNG_PERC.nonabla < 0 ~ 1,
                                  BAA_CHNG_PERC < 0 & BAA_CHNG_PERC.nonabla >= 0 ~ 2,
                                  BAA_CHNG_PERC >= 0 & BAA_CHNG_PERC.nonabla >= 0 ~ 3,
                                  BAA_CHNG_PERC >= 0 & BAA_CHNG_PERC.nonabla < 0 ~ 4),
         quadrant.tpa = case_when(TPA_CHNG_PERC < 0 & TPA_CHNG_PERC.nonabla < 0 ~ 1,
                                  TPA_CHNG_PERC < 0 & TPA_CHNG_PERC.nonabla >= 0 ~ 2,
                                  TPA_CHNG_PERC >= 0 & TPA_CHNG_PERC.nonabla >= 0 ~ 3,
                                  TPA_CHNG_PERC >= 0 & TPA_CHNG_PERC.nonabla < 0 ~ 4)) %>% 
  filter(PREV_TPA.abla > 0 | CURR_TPA.abla > 0) %>% 
  left_join(mort.decomp.abla %>% sf::st_drop_geometry())

## joining province groupings
dall.er.abla <- dall.er.abla %>% 
  sf::st_join(., er2 %>% 
                as(.,"sf") %>% 
                select(ECOPROVCD=MAP_UNIT_S,
                       ECOPROVNAM=MAP_UNIT_N),
              left=T,
              join = sf::st_covered_by) %>% 
  mutate(ECO_GRP_NEW = case_when(ECOPROVCD %in% c("242","M242","M261","M342") ~ "M242",
                                 ECOPROVCD %in% c("341", "M341","342") ~ "M341",
                                 ECOPROVCD %in% c("M331") ~ "M331",
                                 ECOPROVCD %in% c("313", "M313", "321") ~ "M313",
                                 is.na(ECOPROVCD) ~ "M333",
                                 TRUE~ECOPROVCD),
         ECO_GRP_NEW_NAM = case_when(ECO_GRP_NEW == "M242" ~ "Cascade Mixed Forest",
                                     ECO_GRP_NEW == "M313" ~ "AZ-NM Mountains",
                                     ECO_GRP_NEW == "M331" ~ "Southern Rocky Mountain Steppe",
                                     ECO_GRP_NEW == "M332" ~ "Middle Rocky Mountain Steppe",
                                     ECO_GRP_NEW == "M333" ~ "Northern Rocky Mountain Forest-Steppe",
                                     ECO_GRP_NEW == "M341" ~ "zIntermountain Semi-Desert"))


```


## Disturbed area estimates

```{r}

# getting plot-level expansion factors by PLT_CN
popinfo <- rFIA::getDesignInfo(all.fia,type="ALL") %>% 
  left_join(all.fia$POP_STRATUM %>% 
              select(STRATUM_CN=CN,
                     EXPNS),
            by="STRATUM_CN")

# plots with fire mortality
fire.plots <- all.fia$TREE %>% 
  filter(most.recent=="yes",
         #SPCD==19,
         SPCD%in%c(19,93),
         agent_key=="fire") %>% 
  pull(PLT_CN) %>% 
  unique()

# plots with insect mortality
insect.plots <- all.fia$TREE %>% 
  filter(most.recent=="yes",
         # SPCD==19,
         SPCD%in%c(19,93),
         
         agent_key=="insect") %>% 
  pull(PLT_CN) %>% 
  unique()

# plots with disease mortality
disease.plots <- all.fia$TREE %>% 
  filter(most.recent=="yes",
         # SPCD==19,
         SPCD%in%c(19,93),
         
         agent_key=="disease") %>% 
  pull(PLT_CN) %>% 
  unique()

# animal
animal.plots <- all.fia$TREE %>% 
  filter(most.recent=="yes",
         #SPCD==19,
         SPCD%in%c(19,93),
         
         agent_key=="animal") %>% 
  pull(PLT_CN) %>% 
  unique()

# competition
competition.plots <- all.fia$TREE %>% 
  filter(most.recent=="yes",
         # SPCD==19,
         SPCD%in%c(19,93),
         
         agent_key=="competition") %>% 
  pull(PLT_CN) %>% 
  unique()

# weather
weather.plots <- all.fia$TREE %>% 
  filter(most.recent=="yes",
         # SPCD==19,
         SPCD%in%c(19,93),
         
         agent_key=="weather") %>% 
  pull(PLT_CN) %>% 
  unique()

# land use
land.plots <- all.fia$TREE %>% 
  filter(most.recent=="yes",
         # SPCD==19,
         SPCD%in%c(19,93),
         
         agent_key=="land_use") %>% 
  pull(PLT_CN) %>% 
  unique()

# unknown mortality
unknown.plots <- all.fia$TREE %>% 
  filter(most.recent=="yes",
         # SPCD==19,
         SPCD%in%c(19,93),
         
         agent_key=="unknown") %>% 
  pull(PLT_CN) %>% 
  unique()

# total
all.plots <- all.fia$TREE %>% 
  filter(most.recent=="yes",
         #SPCD==19
         SPCD%in%c(19,93)
  ) %>% 
  pull(PLT_CN) %>% 
  unique()

# summing up plot expansion factors for mortality types across all plots
mort.area.all <- all.fia$PLOT %>% 
  left_join(popinfo %>% 
              select(PLT_CN,EXPNS)) %>%
  summarise(fire.area = sum(EXPNS*ifelse(PLT_CN %in% fire.plots, 1, 0), na.rm=T),
            insect.area = sum(EXPNS*ifelse(PLT_CN %in% insect.plots, 1, 0), na.rm=T),
            disease.area = sum(EXPNS*ifelse(PLT_CN %in% disease.plots, 1, 0), na.rm=T),
            id.area = sum(EXPNS*ifelse(PLT_CN %in% c(disease.plots,insect.plots), 1, 0), na.rm=T),
            fid.area = sum(EXPNS*ifelse(PLT_CN %in% c(fire.plots,disease.plots,insect.plots), 1, 0), na.rm=T),
            animal.area = sum(EXPNS*ifelse(PLT_CN %in% animal.plots, 1, 0), na.rm=T),
            competition.area = sum(EXPNS*ifelse(PLT_CN %in% competition.plots, 1, 0), na.rm=T),
            weather.area = sum(EXPNS*ifelse(PLT_CN %in% weather.plots, 1, 0), na.rm=T),
            land.area = sum(EXPNS*ifelse(PLT_CN %in% land.plots, 1, 0), na.rm=T),
            unknown.area = sum(EXPNS*ifelse(PLT_CN %in% unknown.plots, 1, 0), na.rm=T),
            total.area = sum(EXPNS*ifelse(PLT_CN %in% all.plots, 1, 0), na.rm=T))

# summing plot expansion factors for mortality types within ecoregion subsections
mort.area.er <- all.fia$PLOT %>% 
  left_join(popinfo %>% 
              select(PLT_CN,EXPNS)) %>%
  group_by(ECOSUBCD) %>%
  filter(ECOSUBCD %in% er4.abla$MAP_UNIT_S) %>% 
  summarise(area.fire = sum(EXPNS*ifelse(PLT_CN %in% fire.plots, 1, 0), na.rm=T),
            area.insect = sum(EXPNS*ifelse(PLT_CN %in% insect.plots, 1, 0), na.rm=T),
            area.disease = sum(EXPNS*ifelse(PLT_CN %in% disease.plots, 1, 0), na.rm=T),
            area.id = sum(EXPNS*ifelse(PLT_CN %in% c(disease.plots,insect.plots), 1, 0), na.rm=T),
            area.fid = sum(EXPNS*ifelse(PLT_CN %in% c(fire.plots,disease.plots,insect.plots), 1, 0), na.rm=T),
            area.animal = sum(EXPNS*ifelse(PLT_CN %in% animal.plots, 1, 0), na.rm=T),
            area.competition = sum(EXPNS*ifelse(PLT_CN %in% competition.plots, 1, 0), na.rm=T),
            area.weather = sum(EXPNS*ifelse(PLT_CN %in% weather.plots, 1, 0), na.rm=T),
            area.land = sum(EXPNS*ifelse(PLT_CN %in% land.plots, 1, 0), na.rm=T),
            area.unknown = sum(EXPNS*ifelse(PLT_CN %in% unknown.plots, 1, 0), na.rm=T),
            area.total = sum(EXPNS*ifelse(PLT_CN %in% all.plots, 1, 0), na.rm=T))

# joining to main summary dataframe
dall.er.abla <- dall.er.abla %>% 
  left_join(mort.area.er, by = c("MAP_UNIT_S"="ECOSUBCD")) %>% 
  mutate(area.fire.prop = area.fire/area.total,
         area.id.prop = area.id/area.total,
         area.insect.prop = area.insect/area.total,
         area.disease.prop = area.disease/area.total)


```

## T1 and T2 plot attributes

```{r}

evals <- c(21903,41903,61903,81903,161903,301903,321903,351903,411903,491903,531903,561903)

plot.attributes.prev <- growMort_dlp.metric(db = all.fia,
                                     byPlot = T,
                                     bySpecies = F,
                                     stateVar = "BAA",
                                     evals = evals,
                                     #areaDomain = abla.pres==1,
                                     sizeThresh = 12.7,
                                     polys = NULL,
                                     returnSpatial = F)



# plot.attributes.baa <- tpa(db = all.fia %>% 
#                              clipFIA(mostRecent=T),
#                            byPlot=T,
#                            bySpecies=F, 
#                            areaDomain = abla.pres==1,
#                            treeDomain = DIA>=5,
#                            returnSpatial = F)

```

## Forming analysis dataframe

```{r}
abla.plots <- all.fia$TREE %>% 
  filter(most.recent=="yes",
         SPCD==19) %>% 
  pull(PLT_CN) %>% 
  unique()

pien.plots <- all.fia$TREE %>% 
  filter(most.recent=="yes",
         SPCD==93) %>% 
  pull(PLT_CN) %>% 
  unique()

co.occ.plots <- abla.plots[abla.plots%in%pien.plots]

ind.mort.dat <- all.fia$TREE %>% 
  filter(PLT_CN%in%co.occ.plots,
         SPCD%in%c(19,93),
         #PREVDIA>5,
         PREV_STATUS_CD==1,
         STATUSCD%in%c(1,2),
         INVYR>2009) %>% 
  left_join(all.fia$TREE %>% 
              select(TRE_CN,
                     PREV_CR = CR,
                     PREV_HT = HT,
                     PREV_VOL = VOLCFGRS,
                     prev.insect.damage = insect.damage,
                     prev.disease.damage = disease.damage,
                     prev.other.damage = other.damage),
            by=c("PREV_TRE_CN"="TRE_CN")) %>% 
  select(TRE_CN,SPCD,PLT_CN,
         PREV_STATUS_CD,STATUSCD,
         DIA,PREVDIA, PREV_HT, PREV_VOL,
         PREV_CR, 
         prev.insect.damage, prev.disease.damage, prev.other.damage,
         agent_key) %>% 
  mutate(SURV = ifelse(STATUSCD==2,0,STATUSCD)) %>% 
  left_join(.,
            all.fia$PLOT %>% 
              select(PLT_CN,
                     contains("MAT"),
                     contains("MAP"),
                     contains("CMD"),
                     ECOSUBCD, REMPER, ECO_GRP_NEW_NAM,
                     INVYR, ELEV, most.recent) %>% 
              mutate(MAT_anom = MAT_remper-MAT_base,
                     MAP_anom = MAP_remper-MAP_base,
                     CMD_anom = CMD_remper-CMD_base,
                     MAP_relanom = MAP_anom/MAP_base),
            by="PLT_CN") %>%
  left_join(mort.area.er %>% 
              mutate(area.fire.prop = area.fire/area.total,
                     area.id.prop = area.id/area.total),
            by="ECOSUBCD") %>% 
  left_join(plot.attributes.prev) %>% 
  filter(!is.na(MAT_remper),
         !is.na(PREV_BAH))

```

# Modeling

## Variant 1 (FIA meeting model)

This model predicts the individual probability of survival after 10 years (i.e., from t1 to t2) as a function of: 
- t1 stand basal area
- t1 crown ratio (i.e., tree health)
- interactions between recent anomalies and baselines for MAT and MAP
- t1 tree size
- area disturbed by fire and biotic disturbances
- interactions between climate, size, disturbance

The model is a binomial GLMM with a logit link and a random intercept for ecoregion subsection

```{r}

m1 <- glmer(data = ind.mort.dat,
            formula = SURV ~ #as.factor(SPCD) +
              scale(ELEV) +
              scale(PREV_BAH)*as.factor(SPCD) + scale(PREV_CR)*as.factor(SPCD) +
              #scale(MAT_remper)*scale(MAT_anom) + scale(MAP_remper)*scale(MAP_relanom) +
              #scale(MAT_anom)*scale(MAP_relanom) +
              scale(PREVDIA)*scale(MAP_relanom)*scale(MAT_anom)*area.fire.prop*as.factor(SPCD) +
              scale(PREVDIA)*scale(MAP_relanom)*scale(MAT_anom)*area.id.prop*as.factor(SPCD) +
              # scale(PREVDIA)*scale(MAT_anom)*area.fire.prop +
              # scale(PREVDIA)*scale(MAT_anom)*area.id.prop +
              area.fire.prop:area.id.prop +
              #(as.factor(SPCD)|ECOSUBCD) +
              (1|ECOSUBCD),
            family = binomial(link="logit"),
            nAGQ=0,
            control = glmerControl(optim = "nlminbwrap"))


summary(m1)
performance(m1)
```

Here's some model code to see how model fit lines up with mortality estimates at the ecoregion level... 

```{r}

t <- ind.mort.dat %>% 
  mutate(PRED.MORT = 1 - predict(m1,type="response", re.form = NULL)) %>% 
  filter(SPCD==19) %>% 
  group_by(ECOSUBCD) %>% 
  summarise(PRED.MORT.sum = sum(PRED.MORT),
            PRED.MORT.mean = mean(PRED.MORT),
            PRED.MORT.n = n(),
            surv.sum = sum(SURV))

dall.er.abla %>% 
  left_join(t, 
            by = c("MAP_UNIT_S" = "ECOSUBCD")) %>% 
  ggplot(aes(x = MORT_TOTAL/PREV_TOTAL,
             #y = PRED.MORT.sum/PRED.MORT.n
             y = PRED.MORT.mean,
  )) +
  geom_point(pch = 19, alpha = 0.6, size = 3) +
  geom_abline(intercept=0, slope=1, col="red", lwd = 1.5) +
  labs(x = "Estimated mortality (observed)",
       y = "Modelled mortality")

dall.er.abla %>% 
  left_join(t, 
            by = c("MAP_UNIT_S" = "ECOSUBCD")) %>% 
  lm(data = ., PRED.MORT.mean~I(MORT_TOTAL/PREV_TOTAL)) %>% 
  summary(.)

```

```{r}
#median values
#PREV_BAA <- 1000
PREV_BAH <- 12
#PREV_BAA <- 160
PREV_CR <- 60.54
MAP_relanom <- 0.073

ggpredict(m1,
          terms = c("MAT_anom [-1:3, by=0.1]",
                    "area.fire.prop [0,0.075,0.15]",#,0.3]",
                    "area.id.prop [0,0.29,0.6]",#,1]",
                    #"PREVDIA [1,7,20]",
                    "SPCD [19,93]"),
          condition = c(PREVDIA = 2.54,
                        PREV_BAH = PREV_BAH,
                        PREV_CR = PREV_CR,
                        MAP_relanom = MAP_relanom)) %>% 
  as.data.frame() %>%
  mutate(PREVDIA = 2.54) %>% 
  bind_rows(., ggpredict(m1,
                         terms = c("MAT_anom [-1:3, by=0.1]",
                                   "area.fire.prop [0,0.075,0.15]",#,0.3]",
                                   "area.id.prop [0,0.29,0.6]",#,1]",
                                   "SPCD [19,93]"),
                         condition = c(PREVDIA = 20,
                                       PREV_BAH = PREV_BAH,
                                       PREV_CR = PREV_CR,
                                       MAP_relanom = MAP_relanom)) %>% 
              as.data.frame() %>% 
              mutate(PREVDIA = 20)) %>% 
  bind_rows(., ggpredict(m1,
                         terms = c("MAT_anom [-1:3, by=0.1]",
                                   "area.fire.prop [0,0.075,0.15]",#,0.3]",
                                   "area.id.prop [0,0.29,0.6]",#,1]",
                                   "SPCD [19,93]"),
                         condition = c(PREVDIA = 50,
                                       PREV_BAH = PREV_BAH,
                                       PREV_CR = PREV_CR,
                                       MAP_relanom = MAP_relanom)) %>% 
              as.data.frame() %>% 
              mutate(PREVDIA = 50)) %>% 
  rename(MAT_anom = x,
         area.fire.prop = group,
         area.id.prop = facet,
         SPCD = panel) %>%
  #filter(SPCD==19) %>% 
  ggplot(., 
         aes(x = MAT_anom,
             y = predicted,
             groups = factor(SPCD))) +
  geom_ribbon(aes(ymin = conf.low,
                  ymax = conf.high,
                  fill = factor(PREVDIA)),
              alpha=0.1) +
  geom_line(aes(col=factor(PREVDIA),
                lty = factor(SPCD)),
            lwd=1.7) +
  geom_vline(xintercept = 1.2)+
  labs(x = "MAT anomaly (C)",
       y = "Predicted survival",
       title = "")+
  scale_color_manual(name = "Tree size",
                     values = c("2.54" = "orange2",
                                "20" = "dodgerblue3",
                                "50" = "green3")) +
  scale_fill_manual(name = "Tree size",
                    values = c("2.54" = "orange2",
                               "20" = "dodgerblue3",
                               "50" = "green3")) +
  facet_grid(area.id.prop~area.fire.prop,
             labeller = labeller(
               area.fire.prop=as_labeller(
                 c("0" = "0% burned",
                   "0.075"= "Current conditions \n 7.5% burned",
                   "0.15" = "15% burned",
                   "0.3" = "30% burned")),
               area.id.prop=as_labeller(
                 c("0" = "0% bugs",
                   "0.29"= "Current conditions \n 30% bugs",
                   "0.6" = "60% bugs",
                   "1" = "100% bugs"))))
```

```{r}

coefs <- coef(m1)$ECOSUBCD %>% 
  as.data.frame() %>% 
  mutate(SPCD.resp = inv.logit(`as.factor(SPCD)93`),
         ECOSUBCD = row.names(.))

```


ALRIGHT, SO THAT'S SOME PRETTY FUN AND PRODUCTIVE PLAYING.

Next steps:
- clarify what the models are supposed to be asking
- build question into model structure... need to think through species-level random effect versus interaction terms...
- build the change matrix for ABLA/PIEN system (e.g., ms figure 5)
- think about ways that the model can be applied explicitly to the change matrix
- e.g., make a model using only data from each quadrant separately, and compare coefficient estimates
- e.g., build a model with random slopes by quadrant to test whether different things are happening where they're aligned versus not
- think about messages, stories to tell
- e.g., in the absence of disturbance, climate change benefits high-elevation forests; disturbance screws that up 
- e.g., climate change will make our forest trees smaller (mortality of large trees accelerate faster than mortality of small trees)


- think about ways to use P2A links...





### Change matrix:

```{r}
#quadrants:
# 1 = both species decline
# 2 = abla decrease, pien increase
# 3 = both increase
# 4 = pien decrease, abla increase


co.occ.quad <- dall.er.sp %>% 
  filter(SPCD %in% c(19,93)) %>% 
  select(SPCD, MAP_UNIT_S, CHNG_PERC.baa) %>% 
  pivot_wider(names_from=c("SPCD"), 
              values_from="CHNG_PERC.baa",
              names_prefix = "CHNG_PERC.baa.") %>%
  na.omit() %>%
  mutate(quad.baa = case_when(CHNG_PERC.baa.19 < 0 & CHNG_PERC.baa.93 < 0 ~ 1,
                              CHNG_PERC.baa.19 < 0 & CHNG_PERC.baa.93 >= 0 ~ 2,
                              CHNG_PERC.baa.19 >= 0 & CHNG_PERC.baa.93 >= 0 ~ 3,
                              CHNG_PERC.baa.19 >= 0 & CHNG_PERC.baa.93 < 0 ~ 4))


co.occ.quad %>% 
  ggplot(.) +
  geom_point(aes(x = CHNG_PERC.baa.19,
                 y = CHNG_PERC.baa.93),
             pch = 19, size = 3,
             alpha = 0.7) +
  geom_hline(yintercept=0) +
  geom_vline(xintercept=0) +
  geom_abline(slope = 1, intercept = 0)



ggplot() +
  geom_sf(data = cont %>% 
            as(.,"sf"),
          col=linecolor,
          fill = mapcolor) + 
  geom_sf(data = states %>% 
            as(.,"sf"),
          fill=NA,
          col=linecolor) +
  geom_sf(data = co.occ.quad,
          col = linecolor,
          fill = NA)+
  geom_sf(data = co.occ.quad,
          col=NA,
          aes(fill = as.factor(quad.baa))) +
  geom_sf(data = states %>% 
            as(.,"sf"),
          fill=NA,
          col=linecolor,
          alpha=0.1,
          lwd=0.3,
          lty=2) +
  theme(panel.background = element_rect(fill="skyblue1"))+
  scale_fill_discrete(name = "",
   type=c("firebrick4","firebrick2","dodgerblue4","skyblue1"))+
  lims(x = c(-2.5e6, -0.5e6),
       y = c(1.00e6,3.25e6))




```

mortality sources:
```{r}

abla.plots <- all.fia$TREE %>% 
  filter(SPCD==19) %>% 
  pull(PLT_CN) %>% 
  unique()


all.fia$PLOT <- all.fia$PLOT %>% 
  left_join(co.occ.quad %>% 
              sf::st_drop_geometry() %>% 
              select(MAP_UNIT_S,quad.baa),
            by=c("ECOSUBCD"="MAP_UNIT_S")) %>% 
  mutate(co.pres = ifelse(PLT_CN %in% co.occ.plots | PREV_PLT_CN %in% co.occ.plots,
                            1,0))

all.fia$TREE <- all.fia$TREE %>% 
  mutate(focal = case_when(SPCD==19 ~ "abla",
                           SPCD==93 ~ "pien"))

test <- all.fia %>% 
  growMort_dlp.metric(db = .,
               stateVar="BAA",
               # polys=er4.abla %>% 
               #   sf::st_as_sf() %>% 
               #   select(MAP_UNIT_S),
               #treeDomain = SPCD==19,
               areaDomain = co.pres==1,
               totals = TRUE,
               grpBy = c(quad.baa, focal, agent_key),
               #bySpecies = T,
               returnSpatial = F, 
               nCores = 4,
               #variance = T,
               sizeThresh = 5,
               evals = evals,
               method="TI") %>% 
  filter(agent_key!="unknown2",
         !is.na(focal)) %>% 
  group_by(quad.baa) %>% 
  filter(YEAR==max(YEAR))


test %>% 
  group_by(quad.baa, focal) %>% 
  mutate(PREV_TOTAL2=PREV_TOTAL/sum(PREV_TOTAL),
         PREV_TOTAL_SD = sqrt(PREV_TOTAL_VAR)) %>% 
  ggplot(.,
         aes(x = factor(agent_key,levels = c("fire","disease","insect","weather","unknown1","competition","land use", "animal")),
             y = PREV_TOTAL/1e6,
             group=focal))+
  geom_col(aes(fill = as.factor(quad.baa),
               alpha=focal),
           position=position_dodge(0.9),
           col="black") +
  geom_errorbar(aes(ymin = (PREV_TOTAL - (PREV_TOTAL_SE))/1e6,
                    ymax = (PREV_TOTAL + (PREV_TOTAL_SE))/1e6),
                position=position_dodge(0.9),
                width=0.3,
                lwd=0.8)+
  facet_wrap(facets=~factor(quad.baa, levels=c("2","3","1","4")),scales="free_y") +
  scale_fill_discrete(name = "",
                      type=c("firebrick4","firebrick2","dodgerblue4","skyblue1")) +   
  scale_alpha_manual(values = c("abla" = 1,
                                "pien" = 0.3)) +
  xlab("")+
  ylab("Mortality (million trees)")+
  theme(axis.text.x = element_text(angle=45,hjust=1),
        strip.text.x=element_blank())


test %>% 
  group_by(quad.baa, focal) %>% 
  mutate(PREV_TOTAL2=PREV_TOTAL/sum(PREV_TOTAL),
         PREV_TOTAL_SD = sqrt(PREV_TOTAL_VAR)) %>% 
  ggplot(.,
         aes(x = factor(agent_key,levels = c("fire","disease","insect","weather","unknown1","competition","land use", "animal")),
             y = PREV_TOTAL,
             group=focal))+
  geom_col(aes(fill = as.factor(quad.baa),
               alpha=focal),
           position=position_dodge(0.9),
           col="black") +
  geom_errorbar(aes(ymin = (PREV_TOTAL - (PREV_TOTAL_SE)),
                    ymax = (PREV_TOTAL + (PREV_TOTAL_SE))),
                position=position_dodge(0.9),
                width=0.3,
                lwd=0.8)+
  facet_wrap(facets=~factor(quad.baa, levels=c("2","3","1","4")),scales="free_y") +
  scale_fill_discrete(name = "",
                      type=c("firebrick4","firebrick2","dodgerblue4","skyblue1")) +   
  scale_alpha_manual(values = c("abla" = 1,
                                "pien" = 0.3)) +
  xlab("")+
  ylab("Mortality (basal area)")+
  theme(axis.text.x = element_text(angle=45,hjust=1),
        strip.text.x=element_blank())

```
```



```{r}
r <- mort.area.er %>% 
  left_join(co.occ.quad, by=c("ECOSUBCD"="MAP_UNIT_S")) %>% 
  filter(!is.na(quad.baa))

r %>% 
  ggplot(.,
         aes(x = factor(quad.baa),
             y = area.id/area.total)) +
  geom_boxplot()


```


```{r}




```

















